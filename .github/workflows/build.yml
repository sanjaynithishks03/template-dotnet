on:
  push: 
    branches: [main, 'release/**']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:  
  DOTNET_VERSION: '8.0.x' 
  JFROG_REPO_NAME: '' # JFrog repo name to upload the artifact to(default: <repo-name>-generic-dev-local)
  JFROG_REMOTE_REPO_NAME: 'nuget-remote' # JFrog remote repo name to resolve the artifact from
  JFROG_SECURITY_REPO_NAME: '' # JFrog repo for security artifacts (default: <repo-name>-security-local)
  ARTIFACT_NAME: '' # Artifact name to upload to JFrog(default: <repo-name>)

permissions:
  id-token: write
  contents: read
  attestations: write
  security-events: write
  actions: read
  
jobs:    
  build:      
    runs-on: windows-latest
    outputs:
      artifact_name: ${{ steps.setup-build-env.outputs.artifact_name }}
      jfrog_repo_name: ${{ steps.setup-build-env.outputs.jfrog_repo_name }}
      jfrog_security_repo_name: ${{ steps.setup-build-env.outputs.jfrog_security_repo_name }}
    steps:     
    - uses: actions/checkout@v5
   
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: csharp
        queries: security-and-quality

    - name: Setup artifact file name and jfrog repo name
      id: setup-build-env
      shell: pwsh
      run: |
        if ("${{ env.ARTIFACT_NAME }}") {
          $ARTIFACT_NAME_VALUE = "${{ env.ARTIFACT_NAME }}"
        } else {
          $ARTIFACT_NAME_VALUE = "${{ github.event.repository.name }}"
        }
        echo "ARTIFACT_NAME=$ARTIFACT_NAME_VALUE" >> $env:GITHUB_ENV
        echo "artifact_name=$ARTIFACT_NAME_VALUE" >> $env:GITHUB_OUTPUT

        if ("${{ env.JFROG_REPO_NAME }}") {
          $JFROG_REPO_NAME_VALUE = "${{ env.JFROG_REPO_NAME }}"
        } else {
          $JFROG_REPO_NAME_VALUE = "${{ github.event.repository.name }}-generic-dev-local"
        }
        echo "JFROG_REPO_NAME=$JFROG_REPO_NAME_VALUE" >> $env:GITHUB_ENV
        echo "jfrog_repo_name=$JFROG_REPO_NAME_VALUE" >> $env:GITHUB_OUTPUT

        if ("${{ env.JFROG_SECURITY_REPO_NAME }}") {
          $JFROG_SECURITY_REPO_NAME_VALUE = "${{ env.JFROG_SECURITY_REPO_NAME }}"
        } else {
          $JFROG_SECURITY_REPO_NAME_VALUE = "${{ github.event.repository.name }}-security-local"
        }
        echo "JFROG_SECURITY_REPO_NAME=$JFROG_SECURITY_REPO_NAME_VALUE" >> $env:GITHUB_ENV
        echo "jfrog_security_repo_name=$JFROG_SECURITY_REPO_NAME_VALUE" >> $env:GITHUB_OUTPUT

        # For build number tracking
        echo "JFROG_CLI_BUILD_NAME=$ARTIFACT_NAME_VALUE" >> $env:GITHUB_ENV
        echo "JFROG_CLI_BUILD_NUMBER=${{ github.run_number }}" >> $env:GITHUB_ENV

    - name: Create nuget.config
      shell: pwsh
      run: |
        @"
        <?xml version="1.0" encoding="utf-8"?>
        <configuration>
          <packageSources>
            <add key="Artifactory" value="https://${{ vars.JF_URL }}/artifactory/api/v2/nuget/${{ vars.JFROG_REMOTE_REPO_NAME }}/index.json" />
          </packageSources>
        </configuration>
        "@ | Out-File -FilePath src/nuget.config -Encoding utf8

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:  
        JF_URL: ${{ vars.ARTIFACTORY_URL }}
      with:
        oidc-provider-name: github

    - name: Test connection
      run: |
        jf rt ping

    - name: Check code formatting
      working-directory: src
      shell: pwsh
      run: |
        dotnet format --verify-no-changes --verbosity diagnostic

    - name: Restore dependencies
      working-directory: src
      shell: pwsh
      run: |
        dotnet restore --configfile nuget.config 2>&1 | Tee-Object -FilePath restore-output.txt
    
    - name: dotnet build and publish
      shell: pwsh
      run: |          
        dotnet build --no-restore --configuration Release ./src/Project.csproj 2>&1 | Tee-Object -FilePath build-output.txt
        dotnet publish -c Release ./src/Project.csproj -o ./publish 2>&1 | Tee-Object -FilePath publish-output.txt

    - name: Verify JFrog Repositories Exist
      shell: pwsh
      run: |
        Write-Host "Checking if JFrog repository '${{ env.JFROG_REPO_NAME }}' exists..."
        $result = jf rt curl -XGET "/api/repositories/${{ env.JFROG_REPO_NAME }}" --silent --fail 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✓ Repository '${{ env.JFROG_REPO_NAME }}' exists"
        } else {
          Write-Host "✗ ERROR: Repository '${{ env.JFROG_REPO_NAME }}' does not exist in JFrog Artifactory"
          Write-Host "Please create the repository before uploading artifacts"
          exit 1
        }

        Write-Host "Checking if JFrog security repository '${{ env.JFROG_SECURITY_REPO_NAME }}' exists..."
        $result = jf rt curl -XGET "/api/repositories/${{ env.JFROG_SECURITY_REPO_NAME }}" --silent --fail 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✓ Repository '${{ env.JFROG_SECURITY_REPO_NAME }}' exists"
        } else {
          Write-Host "✗ ERROR: Repository '${{ env.JFROG_SECURITY_REPO_NAME }}' does not exist in JFrog Artifactory"
          Write-Host "Please create the security repository as a Generic repository type"
          exit 1
        }

    - name: Generate artifact information
      shell: pwsh
      run: |
        $SHORT_SHA = "${{ github.sha }}".Substring(0, 8)
        $ZIP_NAME = "${{ env.ARTIFACT_NAME }}-${{ github.run_number }}.zip"
        $TIMESTAMP = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
        
        echo "SHORT_SHA=$SHORT_SHA" >> $env:GITHUB_ENV
        echo "ZIP_NAME=$ZIP_NAME" >> $env:GITHUB_ENV
        echo "BUILD_TIMESTAMP=$TIMESTAMP" >> $env:GITHUB_ENV
        
        Write-Host "Artifact ZIP: $ZIP_NAME"
        Write-Host "Git SHA (short): $SHORT_SHA"
        Write-Host "Build timestamp: $TIMESTAMP"

    - name: Zip artifact
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist | Out-Null
        Compress-Archive -Path ./publish/* -DestinationPath "dist/${{ env.ZIP_NAME }}" -Force

    - name: Upload artifact to JFrog Artifactory
      working-directory: dist
      shell: pwsh
      run: |
        jf rt u "${{ env.ZIP_NAME }}" "${{ env.JFROG_REPO_NAME }}/${{ env.ZIP_NAME }}" `
          --build-name ${{ env.ARTIFACT_NAME }} `
          --build-number ${{ github.run_number }}
        
        Write-Host "✓ Artifact uploaded to JFrog"

    - name: Download published artifact for attestation
      shell: pwsh
      run: |
        $JFROG_ARTIFACT_PATH = "${{ env.JFROG_REPO_NAME }}/${{ env.ZIP_NAME }}"
        Write-Host "Downloading published artifact from: $JFROG_ARTIFACT_PATH"
        
        jf rt download "$JFROG_ARTIFACT_PATH" --flat
        
        if (-not (Test-Path "${{ env.ZIP_NAME }}")) {
          Write-Host "❌ Failed to download published artifact"
          exit 1
        }
        
        Write-Host "✓ Published artifact downloaded for attestation"
        
        # Calculate and display the digest for verification
        $DIGEST = (Get-FileHash -Path "${{ env.ZIP_NAME }}" -Algorithm SHA256).Hash
        Write-Host "Artifact SHA256: $DIGEST"
        echo "ARTIFACT_DIGEST=$DIGEST" >> $env:GITHUB_ENV

    - name: Attest artifact with GitHub
      id: attest
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: '${{ env.ZIP_NAME }}'

    - name: Create custom attestation with actor info
      id: attest-actor
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.ZIP_NAME }}'
        predicate-type: 'https://github.com/attestation/actor/v1'
        predicate: |
          {
            "actor": "${{ github.actor }}",
            "actorId": "${{ github.actor_id }}",
            "repository": "${{ github.repository }}",
            "repositoryOwner": "${{ github.repository_owner }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "workflowRef": "${{ github.workflow_ref }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "runAttempt": "${{ github.run_attempt }}",
            "timestamp": "${{ env.BUILD_TIMESTAMP }}"
          }

    - name: Add attestation metadata to JFrog artifact
      shell: pwsh
      run: |
        $ARTIFACT_PATH = "${{ env.JFROG_REPO_NAME }}/${{ env.ZIP_NAME }}"
        
        Write-Host "Setting properties on: $ARTIFACT_PATH"
        jf rt set-props "$ARTIFACT_PATH" `
          "git.commit.sha=${{ github.sha }};git.commit.short=${{ env.SHORT_SHA }};git.branch=${{ github.ref_name }};build.name=${{ env.ARTIFACT_NAME }};build.number=${{ github.run_number }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.actor=${{ github.actor }};attestation.trigger=${{ github.event_name }};attestation.commit=${{ github.sha }};attestation.provenance.bundle=${{ steps.attest.outputs.bundle-path }};attestation.actor.bundle=${{ steps.attest-actor.outputs.bundle-path }};attestation.sigstore.enabled=true;security.repo=${{ env.JFROG_SECURITY_REPO_NAME }}"
        
        Write-Host "✓ Attestation metadata added to artifact in JFrog"
        Write-Host "  Artifact: $ARTIFACT_PATH"
        Write-Host "  Git SHA: ${{ env.SHORT_SHA }}"
        Write-Host "  Build: ${{ env.ARTIFACT_NAME }}/${{ github.run_number }}"

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:csharp"
        output: codeql-results
        upload: false

    - name: Find CodeQL SARIF results
      id: sarif-info
      shell: bash
      run: |
        SARIF_FILE=$(find codeql-results -name "*.sarif" -type f | head -n 1)
        if [ -z "$SARIF_FILE" ]; then
          echo "Error: No SARIF file found"
          exit 1
        fi
        echo "SARIF_FILE=$SARIF_FILE" >> $GITHUB_ENV
        echo "Found SARIF file: $SARIF_FILE"
        
        # Generate SARIF filename for JFrog (using build number for uniqueness)
        SARIF_JFROG_NAME="${{ env.BUILD_NAME }}-codeql-${{ github.run_number }}.sarif"
        echo "SARIF_JFROG_NAME=$SARIF_JFROG_NAME" >> $GITHUB_ENV
        echo "JFrog SARIF name: $SARIF_JFROG_NAME"

    - name: Attest CodeQL SARIF results
      id: attest-codeql
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.SARIF_FILE }}'
        predicate-type: 'https://github.com/attestation/codeql/v1'
        predicate: |
          {
            "scanType": "codeql",
            "language": "javascript",
            "queries": "security-and-quality",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "resultsFile": "${{ env.SARIF_FILE }}"
          }

    - name: Upload CodeQL SARIF to JFrog
      shell: bash
      run: |
        cp "${{ env.SARIF_FILE }}" "${{ env.SARIF_JFROG_NAME }}"
        
        jf rt upload "${{ env.SARIF_JFROG_NAME }}" "${{ env.JFROG_SECURITY_REPO_NAME }}/" \
          --build-name=${{ env.BUILD_NAME }} \
          --build-number=${{ github.run_number }} \
          --module=${{ env.BUILD_NAME }}-security
        
        echo "✓ CodeQL SARIF uploaded to JFrog security repository"

    - name: Add CodeQL attestation metadata to SARIF in JFrog
      shell: bash
      run: |
        SARIF_ARTIFACT_PATH="${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }}"
        
        jf rt set-props "${SARIF_ARTIFACT_PATH}" \
          "git.commit.sha=${{ github.sha }};git.commit.short=${{ env.SHORT_SHA }};git.branch=${{ github.ref_name }};build.name=${{ env.BUILD_NAME }};build.number=${{ github.run_number }};scan.type=codeql;scan.language=csharp;attestation.codeql.bundle=${{ steps.attest-codeql.outputs.bundle-path }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.commit=${{ github.sha }};attestation.sigstore.enabled=true;related.artifact=${{ env.ZIP_NAME }};related.package.repo=${{ env.JFROG_REPO_NAME }}"
        
        echo "✓ CodeQL attestation metadata added to SARIF in JFrog"
        echo "✓ SARIF file location: ${SARIF_ARTIFACT_PATH}"

    - name: Link package to SARIF security artifact
      shell: bash
      run: |
        # Add bidirectional link from package to its SARIF file
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.ARTIFACT_NAME }}"
        
        jf rt set-props "${ARTIFACT_PATH}" \
          "security.sarif.file=${{ env.SARIF_JFROG_NAME }};security.sarif.path=${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }};security.scan.type=codeql;security.scan.language=csharp;security.scan.attestation=${{ steps.attest-codeql.outputs.bundle-path }}"
        
        echo "✓ Package linked to SARIF security artifact"
        echo "✓ Package: ${ARTIFACT_PATH}"
        echo "✓ SARIF: ${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }}"

    - name: Generate SBOM
      id: generate-sbom
      shell: bash
      run: |
        SBOM_JFROG_NAME="${{ env.BUILD_NAME }}-sbom-${{ github.run_number }}.json"
        
        echo "Generating SBOM in CycloneDX format..."
        jf npm sbom --sbom-format=cyclonedx > "$SBOM_JFROG_NAME"
        
        echo "SBOM_JFROG_NAME=$SBOM_JFROG_NAME" >> $GITHUB_ENV
        echo "✓ SBOM generated: $SBOM_JFROG_NAME"
        
        # Display SBOM summary
        if command -v jq &> /dev/null; then
          COMPONENT_COUNT=$(jq '.components | length' "$SBOM_JFROG_NAME" 2>/dev/null || echo "unknown")
          echo "  Components: $COMPONENT_COUNT"
        fi

    - name: Attest SBOM
      id: attest-sbom
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.SBOM_JFROG_NAME }}'
        predicate-type: 'https://cyclonedx.org/bom'
        predicate: |
          {
            "format": "CycloneDX",
            "version": "1.5",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "package": "${{ env.ZIP_NAME }}"
          }

    - name: Upload SBOM to JFrog
      shell: bash
      run: |
        jf rt upload "${{ env.SBOM_JFROG_NAME }}" "${{ env.JFROG_SECURITY_REPO_NAME }}/" \
          --build-name=${{ env.BUILD_NAME }} \
          --build-number=${{ github.run_number }} \
          --module=${{ env.BUILD_NAME }}-security
        
        echo "✓ SBOM uploaded to JFrog security repository"

    - name: Add SBOM attestation metadata to JFrog
      shell: bash
      run: |
        SBOM_ARTIFACT_PATH="${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SBOM_JFROG_NAME }}"
        
        jf rt set-props "${SBOM_ARTIFACT_PATH}" \
          "git.commit.sha=${{ github.sha }};git.commit.short=${{ env.SHORT_SHA }};git.branch=${{ github.ref_name }};build.name=${{ env.BUILD_NAME }};build.number=${{ github.run_number }};sbom.format=cyclonedx;sbom.type=software-bill-of-materials;attestation.sbom.bundle=${{ steps.attest-sbom.outputs.bundle-path }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.commit=${{ github.sha }};attestation.sigstore.enabled=true;related.artifact=${{ env.ZIP_NAME }};related.package.repo=${{ env.JFROG_REPO_NAME }}"
        
        echo "✓ SBOM attestation metadata added to JFrog"
        echo "✓ SBOM file location: ${SBOM_ARTIFACT_PATH}"

    - name: Link package to SBOM security artifact
      shell: bash
      run: |
        # Add bidirectional link from package to its SBOM file
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.ARTIFACT_NAME }}"
        
        jf rt set-props "${ARTIFACT_PATH}" \
          "security.sbom.file=${{ env.SBOM_JFROG_NAME }};security.sbom.path=${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SBOM_JFROG_NAME }};security.sbom.format=cyclonedx;security.sbom.attestation=${{ steps.attest-sbom.outputs.bundle-path }}"
        
        echo "✓ Package linked to SBOM security artifact"
        echo "✓ Package: ${ARTIFACT_PATH}"
        echo "✓ SBOM: ${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SBOM_JFROG_NAME }}"

    - name: Collect build environment 
      run: |
        jf rt build-collect-env ${{ env.ARTIFACT_NAME }} ${{ github.run_number }}
        jf rt build-add-git ${{ env.ARTIFACT_NAME }} ${{ github.run_number }}

    - name: Publish build-info to JFrog
      run: |
        jf rt build-publish ${{ env.ARTIFACT_NAME }} ${{ github.run_number }}
        Write-Host "✓ Build info published to JFrog"

  release-bundle:
    name: Create Release Bundle
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/heads/release/') && github.actor != 'dependabot[bot]' && github.actor != 'dependabot'
    environment: DEV
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:  
        JF_URL: ${{ vars.ARTIFACTORY_URL }}
      with:
        oidc-provider-name: github
    
    - name: Test connection
      run: |
        jf rt ping

    - name: Set build environment from build job
      run: |
        echo "ARTIFACT_NAME=${{ needs.build.outputs.artifact_name }}" >> $GITHUB_ENV
        echo "JFROG_CLI_BUILD_NAME=${{ needs.build.outputs.artifact_name }}" >> $GITHUB_ENV
        echo "JFROG_CLI_BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
        echo "JFROG_REPO_NAME=${{ needs.build.outputs.jfrog_repo_name }}" >> $GITHUB_ENV
        echo "JFROG_SECURITY_REPO_NAME=${{ needs.build.outputs.jfrog_security_repo_name }}" >> $GITHUB_ENV

    - name: Extract version from branch name
      run: |
        if [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
          VERSION=${GITHUB_REF#refs/heads/release/}
          echo "PACKAGE_VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Release version: ${VERSION}"
        else
          echo "Error: Not a release branch"
          exit 1
        fi

    - name: Generate bundle version
      run: |
        echo "BUNDLE_VERSION=${{ env.PACKAGE_VERSION }}_build.${{ github.run_number }}" >> $GITHUB_ENV
        echo "Bundle version: ${{ env.PACKAGE_VERSION }}_build.${{ github.run_number }}"

    - name: Verify build exists in JFrog
      run: |
        echo "=== Verifying Build Info Exists ==="
        echo "Build Name: ${{ env.ARTIFACT_NAME }}"
        echo "Build Number: ${{ github.run_number }}"
        echo ""
        
        # Check if build exists
        if ! build_info=$(jf rt curl -XGET "/api/build/${{ env.ARTIFACT_NAME }}/${{ github.run_number }}" --silent --fail 2>&1); then
          echo "❌ ERROR: Build info not found!"
          echo ""
          echo "This usually means the build-info was not published in the build job."
          echo "Please check the 'Publish build-info to JFrog' step in the build job."
          exit 1
        fi
        
        echo "✓ Build info found"
        echo ""
        echo "✓ Build verification complete"

    - name: Create release bundle
      run: |
        echo "=== Creating Release Bundle ==="
        echo "Bundle Name: ${{ env.ARTIFACT_NAME }}"
        echo "Bundle Version: ${{ env.BUNDLE_VERSION }}"
        echo "Source Build: ${{ env.ARTIFACT_NAME }}/${{ github.run_number }}"
        echo ""
        
        # Create bundle from build
        jf rbc \
          --build-name=${{ env.ARTIFACT_NAME }} \
          --build-number=${{ github.run_number }} \
          --sync=true \
          ${{ env.ARTIFACT_NAME }} \
          ${{ env.BUNDLE_VERSION }}
        
        echo ""
        echo "✓ Release bundle created successfully"

    - name: Calculate bundle digest for attestation
      id: bundle-digest
      run: |
        # Create a stable representation of the bundle for attestation
        bundle_subject="${{ env.ARTIFACT_NAME }}:${{ env.BUNDLE_VERSION }}"
        bundle_digest=$(echo -n "$bundle_subject" | sha256sum | awk '{print $1}')
        echo "bundle_digest=${bundle_digest}" >> $GITHUB_OUTPUT
        echo "Bundle digest: ${bundle_digest}"

    - name: Fetch approval information
      id: get-approvers
      run: |
        # Fetch approvers from GitHub API
        APPROVERS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/approvals \
          --jq '[.[] | .user.login] | join(",")' 2>/dev/null || echo "")
        
        if [ -z "$APPROVERS" ]; then
          echo "No approvals found (environment may not require reviewers)"
          echo "approvers=automatic" >> $GITHUB_OUTPUT
        else
          echo "Approved by: ${APPROVERS}"
          echo "approvers=${APPROVERS}" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Promote release bundle to dev
      run: |
        jf rbp \
          --include-repos "${{ env.JFROG_REPO_NAME }};${{ env.JFROG_SECURITY_REPO_NAME }}" \
          ${{ env.ARTIFACT_NAME }} \
          ${{ env.BUNDLE_VERSION }} \
          DEV

    - name: Get promotion timestamp
      id: get-promotion-timestamp
      run: |
        PROMOTION_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        echo "promotion_timestamp=${PROMOTION_TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "Promotion timestamp: ${PROMOTION_TIMESTAMP}"

    - name: Create initial promotion attestation
      id: attest-promotion
      uses: actions/attest@v2
      with:
        subject-name: "${{ env.ARTIFACT_NAME }}/${{ env.BUNDLE_VERSION }} - BUILD -> DEV"
        subject-digest: "sha256:${{ steps.bundle-digest.outputs.bundle_digest }}"
        predicate-type: 'https://github.com/attestation/promotion/v1'
        predicate: |
          {
            "triggeredBy": "${{ github.actor }}",
            "triggeredById": "${{ github.actor_id }}",
            "approvedBy": "${{ steps.get-approvers.outputs.approvers }}",
            "sourceEnvironment": "BUILD",
            "targetEnvironment": "DEV",
            "bundleName": "${{ env.ARTIFACT_NAME }}",
            "bundleVersion": "${{ env.BUNDLE_VERSION }}",
            "repository": "${{ github.repository }}",
            "repositoryOwner": "${{ github.repository_owner }}",
            "workflow": "${{ github.workflow }}",
            "workflowRef": "${{ github.workflow_ref }}",
            "workflowRunId": "${{ github.run_id }}",
            "workflowRunNumber": "${{ github.run_number }}",
            "workflowRunAttempt": "${{ github.run_attempt }}",
            "timestamp": "${{ steps.get-promotion-timestamp.outputs.promotion_timestamp }}",
            "verificationUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }

    - name: Update release bundle properties with attestation
      run: |
        # Update the promoted artifacts with attestation metadata
        jf rt set-props \
          "${{ env.JFROG_REPO_NAME }}/*" \
          --include-dirs \
          --build "${{ env.ARTIFACT_NAME }}/${{ github.run_number }}" \
          "promotion.source=BUILD;promotion.target=DEV;promotion.actor=${{ github.actor }};promotion.actor.id=${{ github.actor_id }};promotion.approver=${{ steps.get-approvers.outputs.approvers }};promotion.timestamp=${{ steps.get-promotion-timestamp.outputs.promotion_timestamp }};git.commit.sha=${{ github.sha }};git.branch=${{ github.ref_name }};workflow.run.id=${{ github.run_id }};workflow.run.number=${{ github.run_number }};attestation.bundle.path=${{ steps.attest-promotion.outputs.bundle-path }}"

    - name: Log promotion attestation
      run: |
        echo "✓ Initial promotion attestation created"
        echo "Bundle: ${{ env.ARTIFACT_NAME }} v${{ env.BUNDLE_VERSION }}"
        echo "Promotion: BUILD → DEV"
        echo "Triggered by: ${{ github.actor }}"
        echo "Attestation bundle: ${{ steps.attest-promotion.outputs.bundle-path }}"
        echo ""
        echo "View attestation at: https://github.com/${{ github.repository }}/attestations"